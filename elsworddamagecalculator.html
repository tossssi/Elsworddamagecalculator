<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELSWORDステータス効率計算</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0d0d0d;
            --card-bg: #1a1a1a;
            --card-hover: #252525;
            --input-bg: #000000;
            --text-main: #ffffff;
            --text-sub: #aaa;
            
            --accent-cyan: #00e5ff;
            --accent-yellow: #ffea00;
            --border-dim: #333;
            --danger: #ff4444;
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            font-size: 14px;
        }

        .container {
            width: 100%;
            max-width: 950px; /* 文字数増えたので少し幅広げた */
        }

        /* ヘッダー */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: #111;
            border-bottom: 1px solid var(--border-dim);
            margin-bottom: 10px;
            border-radius: 8px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        h1 {
            font-size: 1.2rem;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            letter-spacing: 1px;
        }

        .total-display-compact {
            font-size: 1.5rem;
            font-weight: 800;
            color: #fff;
        }
        .total-label-compact {
            font-size: 0.8rem;
            color: var(--accent-cyan);
            margin-right: 10px;
        }

        /* Stats List */
        .stats-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: 4px;
            overflow: hidden;
            border-left: 3px solid transparent;
        }

        /* 1行ヘッダー */
        .stat-header {
            position: relative;
            height: 36px;
            padding: 0 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            overflow: hidden;
        }
        .stat-header:hover {
            background-color: var(--card-hover);
        }

        /* 背景バー（効率グラフ） */
        .bg-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: var(--accent-cyan);
            opacity: 0.1;
            z-index: 0;
            width: 0%;
            transition: width 0.5s ease;
        }

        /* コンテンツ */
        .header-content {
            position: relative;
            z-index: 1;
            display: flex;
            width: 100%;
            justify-content: space-between;
            align-items: center;
        }

        .stat-name {
            font-weight: bold;
            font-size: 0.95rem;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
        }

        .meta-group {
            display: flex;
            align-items: center;
            font-family: monospace;
            white-space: nowrap;
        }

        /* ラベルと数値のスタイル */
        .label-text {
            font-size: 0.75rem;
            color: #888;
            margin-right: 4px;
        }
        .val-text { 
            font-size: 1rem; 
            color: #fff; 
            min-width: 60px; /* 数値の幅確保 */
            text-align: right;
        }
        .eff-text { 
            font-size: 0.9rem; 
            color: var(--accent-cyan); 
            min-width: 60px;
            text-align: right; 
        }
        
        /* 間隔調整 */
        .spacer {
            width: 20px;
        }

        .arrow { font-size: 0.8rem; color: #555; margin-left: 10px; transition: transform 0.3s; }
        
        /* ランク1位の特別色 */
        .stat-card[data-rank="1"] { border-left-color: var(--accent-yellow); }
        .stat-card[data-rank="1"] .eff-text { color: var(--accent-yellow); }
        .stat-card[data-rank="1"] .bg-bar { background-color: var(--accent-yellow); opacity: 0.15; }

        .stat-card:not([data-rank="1"]) { border-left-color: var(--accent-cyan); }

        /* Details Section */
        .details-section {
            background-color: #111;
            border-top: 1px solid #222;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
        }
        .details-section.open { max-height: 2000px; padding: 10px; overflow: visible; }
        .details-section.open + .header-content .arrow { transform: rotate(180deg); } 

        .breakdown-row {
            display: grid;
            gap: 8px;
            margin-bottom: 4px;
            align-items: center;
        }
        
        .breakdown-row.crit { grid-template-columns: 1fr 70px 15px 60px 30px; }
        .breakdown-row.simple { grid-template-columns: 1fr 70px 15px 30px; }

        .breakdown-row input[type="text"] {
            background: transparent; border: none; color: #aaa; border-bottom: 1px solid #333; 
            padding: 2px 5px; width: 100%; font-size: 0.9rem;
        }
        .breakdown-row input[type="number"] {
            background: var(--input-bg); border: 1px solid #333; border-radius: 4px; color: #fff; 
            padding: 4px; text-align: right; font-weight: bold; width: 100%; font-size: 0.9rem;
        }
        .breakdown-row select {
            background: #222; border: 1px solid #444; color: #fff; padding: 2px; border-radius: 4px; font-size: 0.8rem;
        }
        
        .unit-label { color: #555; font-size: 0.8rem; text-align: center; }

        .remove-btn { 
            color: #666; cursor: pointer; text-align: center; font-weight: bold; font-size: 1rem;
            line-height: 24px; height: 24px; border-radius: 4px;
        }
        .remove-btn:hover { background-color: var(--danger); color: #fff; }
        .remove-placeholder { height: 24px; width: 100%; }

        .add-btn {
            background: #222; border: 1px dashed #444; color: #666; width: 100%; 
            padding: 4px; border-radius: 4px; cursor: pointer; margin-top: 5px; font-size: 0.8rem;
        }
        .add-btn:hover { background: #333; color: #fff; }
        
        .formula-note { font-size: 0.7rem; color: #555; margin-bottom: 5px; font-style: italic; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ELSWORDステータス効率計算</h1>
        <div>
            <span class="total-label-compact">TOTAL MULTIPLIER</span>
            <span class="total-display-compact" id="totalDisplay">0.00</span>
        </div>
    </header>

    <div class="stats-list" id="statsList"></div>
</div>

<script>
    // データ初期設定
    let statsData = [
        { 
            id: "atk_percent", 
            name: "物魔攻撃力(%)", 
            calcType: "simple",
            items: [
                { label: "基礎値(固定)", val: 100, fixed: true },
                { label: "武器魔力石効果", val: 49.5 },
                { label: "エクサ再錬効果", val: 8 },
                { label: "レアバセット効果", val: 6 },
                { label: "レアバアクセ効果", val: 9 },
                { label: "スキリン効果", val: 0.5 },
                { label: "ペット効果", val: 2 },
                { label: "アーティファクト効果", val: 3 },
                { label: "エルコレ効果", val: 3.75 },
                { label: "シナジー", val: 1 }
            ] 
        },
        { 
            id: "cri_dmg", 
            name: "クリティカルダメージ", 
            calcType: "crit",
            items: [
                { label: "ステータス表記", val: 215.00, type: "stat_window", fixed: false },
                { label: "加算パッシブ", val: 0, type: "add", fixed: false },
                { label: "乗算パッシブ", val: 0, type: "multi", fixed: false },
                { label: "アットマ草木", val: 26, type: "multi", fixed: false },
                { label: "エクサ赤セット", val: 10, type: "multi", fixed: false },
                { label: "刻印", val: 5, type: "multi", fixed: false },
                { label: "マエストロヘイロー", val: 2, type: "multi", fixed: false },
            ]
        },
        { 
            id: "boss_dmg", 
            name: "ボスに与えるダメージ", 
            calcType: "simple",
            items: [
                { label: "基礎値(固定)", val: 100, fixed: true },
                { label: "ステータス表記", val: 150.00 },
                { label: "加算パッシブ", val: 20.00 },
                { label: "ギルドスキル", val: 2.50 }
            ]
        },
        { 
            id: "all_skill", 
            name: "全スキルダメージ", 
            calcType: "simple",
            items: [{ label: "基礎値(固定)", val: 100, fixed: true }, { label: "ステータス表記", val: 104.50 }] 
        },
        { 
            id: "trans_skill", 
            name: "強烈or超越スキル", 
            calcType: "simple",
            items: [{ label: "基礎値(固定)", val: 100, fixed: true }, { label: "ステータス表記", val: 122.00 }] 
        },
        { 
            id: "polar", 
            name: "両極化：攻撃/被撃", 
            calcType: "simple",
            items: [{ label: "基礎値(固定)", val: 100, fixed: true }, { label: "ステータス表記", val: 53.70 }] 
        },
        { 
            id: "dot", 
            name: "与えた持続ダメージ", 
            calcType: "simple",
            items: [
                { label: "基礎値(固定)", val: 100, fixed: true },
                { label: "リンクアバ効果", val: 2.00 },
                { label: "エクサ上衣回路", val: 12.00 },
                { label: "エクサチップ", val: 12.00 },
                { label: "アットマ上アクセ", val: 5.00 },
                { label: "レアバセット効果", val: 12.00 },
                { label: "レアバ武器効果", val: 5.00 },
                { label: "レアバアクセ効果", val: 7.00 },
                { label: "シナジー：歪曲", val: 2.00 }
            ]
        },
        { 
            id: "hp100_under", 
            name: "HP100%以下の敵へ", 
            calcType: "simple",
            items: [
                { label: "基礎値(固定)", val: 100, fixed: true },
                { label: "武器効果", val: 5 },
                { label: "レアバセット効果", val: 10 }
            ] 
        },
        { 
            id: "hp50_over", 
            name: "HP50%超過の敵へ", 
            calcType: "simple",
            items: [
                { label: "基礎値(固定)", val: 100, fixed: true },
                { label: "エクサ回路効果", val: 10 },
                { label: "エクサチップ効果", val: 5 }
            ] 
        },
        { 
            id: "hp50_under", 
            name: "HP50%以下の敵へ", 
            calcType: "simple",
            items: [
                { label: "基礎値(固定)", val: 100, fixed: true },
                { label: "エクサ回路効果", val: 10 },
                { label: "エクサチップ効果", val: 5 }
            ] 
        },
        { 
            id: "hp30", 
            name: "HP30%以下の敵へ", 
            calcType: "simple",
            items: [
                { label: "基礎値(固定)", val: 100, fixed: true },
                { label: "ソケット効果", val: 0 }
            ] 
        },
    ];

    const listContainer = document.getElementById('statsList');
    const totalDisplay = document.getElementById('totalDisplay');

    function init() {
        render();
        calculate();
    }

    function render() {
        listContainer.innerHTML = '';
        statsData.forEach((cat, index) => {
            const card = document.createElement('div');
            card.className = 'stat-card';
            card.id = `card-${index}`;

            // Header (1行・コンパクト・ラベル追加版)
            const header = document.createElement('div');
            header.className = 'stat-header';
            header.onclick = () => toggleDetails(index);
            header.innerHTML = `
                <div class="bg-bar" id="bar-${index}"></div>
                <div class="header-content">
                    <div class="stat-name">${cat.name}</div>
                    <div class="meta-group">
                        <span class="label-text">合計:</span>
                        <span class="val-text" id="total-${index}">0%</span>
                        
                        <div class="spacer"></div>
                        
                        <span class="label-text">1%上昇効率:</span>
                        <span class="eff-text" id="eff-${index}">+0%</span>
                        
                        <span class="arrow" id="arrow-${index}">▼</span>
                    </div>
                </div>
            `;

            // Details
            const details = document.createElement('div');
            details.className = 'details-section';
            details.id = `details-${index}`;

            if(cat.calcType === 'crit') {
                const note = document.createElement('div');
                note.className = 'formula-note';
                note.innerText = '式: (ステ窓 - 150) + 加算 + (150 × 乗算)';
                details.appendChild(note);
            }

            const rowsContainer = document.createElement('div');
            rowsContainer.id = `rows-${index}`;
            details.appendChild(rowsContainer);

            const addBtn = document.createElement('button');
            addBtn.className = 'add-btn';
            addBtn.innerText = '＋ 項目を追加';
            addBtn.onclick = (e) => { e.stopPropagation(); addItem(index); };
            details.appendChild(addBtn);

            card.appendChild(header);
            card.appendChild(details);
            listContainer.appendChild(card);

            renderRows(index);
        });
    }

    function renderRows(catIndex) {
        const container = document.getElementById(`rows-${catIndex}`);
        const cat = statsData[catIndex];
        container.innerHTML = '';
        
        cat.items.forEach((item, itemIndex) => {
            const row = document.createElement('div');
            row.className = cat.calcType === 'crit' ? 'breakdown-row crit' : 'breakdown-row simple';

            // 1. 名前
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.value = item.label;
            nameInput.placeholder = '項目名';
            if(item.fixed) nameInput.readOnly = true;
            nameInput.oninput = (e) => { cat.items[itemIndex].label = e.target.value; };

            // 2. 数値
            const valInput = document.createElement('input');
            valInput.type = 'number';
            valInput.value = item.val;
            valInput.step = '0.1';
            if(item.fixed) valInput.className = 'fixed-val';
            valInput.oninput = (e) => {
                let v = parseFloat(e.target.value);
                if(isNaN(v)) v = 0;
                cat.items[itemIndex].val = v;
                calculate();
            };
            
            // 3. 単位(%)
            const unitLabel = document.createElement('div');
            unitLabel.className = 'unit-label';
            unitLabel.innerText = '%';

            row.appendChild(nameInput);
            row.appendChild(valInput);
            row.appendChild(unitLabel);

            // 4. タイプ選択 (Critのみ)
            if (cat.calcType === 'crit') {
                if (item.type === 'stat_window') {
                   const emptyBox = document.createElement('div');
                   row.appendChild(emptyBox);
                } else {
                    const typeSelect = document.createElement('select');
                    const ops = [
                        {val: 'add', text: '加算'},
                        {val: 'multi', text: '乗算'},
                    ];
                    
                    ops.forEach(o => {
                        const op = document.createElement('option');
                        op.value = o.val;
                        op.text = o.text;
                        if(item.type === o.val) op.selected = true;
                        typeSelect.appendChild(op);
                    });
                    typeSelect.onchange = (e) => {
                        cat.items[itemIndex].type = e.target.value;
                        calculate();
                    };
                    row.appendChild(typeSelect);
                }
            }

            // 5. 削除
            if(!item.fixed) {
                const delBtn = document.createElement('div');
                delBtn.className = 'remove-btn';
                delBtn.innerText = '×';
                delBtn.onclick = () => {
                    cat.items.splice(itemIndex, 1);
                    renderRows(catIndex);
                    calculate();
                };
                row.appendChild(delBtn);
            } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'remove-placeholder';
                row.appendChild(placeholder);
            }

            container.appendChild(row);
        });
    }

    function addItem(catIndex) {
        const cat = statsData[catIndex];
        const type = cat.calcType === 'crit' ? 'multi' : 'add';
        cat.items.push({ label: '新規', val: 0, fixed: false, type: type });
        renderRows(catIndex);
    }

    function toggleDetails(index) {
        document.getElementById(`details-${index}`).classList.toggle('open');
        const arrow = document.getElementById(`arrow-${index}`);
        if(document.getElementById(`details-${index}`).classList.contains('open')) {
            arrow.style.transform = 'rotate(180deg)';
        } else {
            arrow.style.transform = 'rotate(0deg)';
        }
    }

    function calculate() {
        let globalMultiplier = 1.0;
        let efficiencies = [];

        statsData.forEach((cat, idx) => {
            let catTotal = 0;

            if (cat.calcType === 'crit') {
                let additiveTotal = 0;
                let multiplierProduct = 1.0;

                cat.items.forEach(item => {
                    if (item.type === 'stat_window') {
                        additiveTotal += (item.val - 150);
                    } else if (item.type === 'add') {
                        additiveTotal += item.val;
                    } else if (item.type === 'multi') {
                        multiplierProduct *= (1 + item.val / 100);
                    }
                });

                const base = 150;
                catTotal = additiveTotal + (base * multiplierProduct);

            } else {
                catTotal = cat.items.reduce((sum, item) => sum + item.val, 0);
            }

            if (catTotal <= 0) catTotal = 1;

            document.getElementById(`total-${idx}`).innerText = catTotal.toFixed(2) + '%';
            
            globalMultiplier *= (catTotal / 100);

            const eff = (1 / catTotal) * 100;
            efficiencies.push({ index: idx, val: eff });
            document.getElementById(`eff-${idx}`).innerText = '+' + eff.toFixed(3) + '%';
        });

        const maxEff = Math.max(...efficiencies.map(e => e.val));
        const sorted = [...efficiencies].sort((a, b) => b.val - a.val);

        efficiencies.forEach(item => {
            const rank = sorted.findIndex(e => e.index === item.index) + 1;
            const card = document.getElementById(`card-${item.index}`);
            const bar = document.getElementById(`bar-${item.index}`);
            
            card.setAttribute('data-rank', rank);
            const width = (item.val / maxEff) * 100;
            bar.style.width = `${width}%`;
        });

        totalDisplay.innerText = globalMultiplier.toLocaleString(undefined, { maximumFractionDigits: 2, minimumFractionDigits: 2 });
    }

    init();

</script>

</body>
</html>