<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELSWORDã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åŠ¹ç‡è¨ˆç®—</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0d0d0d;
            --card-bg: #1a1a1a;
            --card-hover: #252525;
            --input-bg: #000000;
            --text-main: #ffffff;
            --text-sub: #aaa;
            
            --accent-cyan: #00e5ff;
            --accent-yellow: #ffea00;
            --alert-red: #ff4444;
            --border-dim: #333;
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif; /* å…¨ä½“ã‚’ã“ã®ãƒ•ã‚©ãƒ³ãƒˆã§çµ±ä¸€ */
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            font-size: 14px;
        }

        .container {
            width: 100%;
            max-width: 950px;
        }

        /* ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
        .nav-area {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 8px;
            padding: 0 5px;
        }

        .help-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-cyan), #00b8cc);
            border: none;
            color: #000;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 0 5px rgba(0, 229, 255, 0.5);
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        .help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--accent-cyan);
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #111;
            border-bottom: 1px solid var(--border-dim);
            margin-bottom: 10px;
            border-radius: 8px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        h1 {
            font-size: 1.3rem;
            color: #e0e0e0;
            margin: 0;
            letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.6);
            font-weight: 800;
        }

        .total-display-compact {
            font-size: 1.5rem;
            font-weight: 800;
            color: #fff;
        }
        .total-label-compact {
            font-size: 0.8rem;
            color: #888;
            margin-right: 10px;
        }

        /* Stats List */
        .stats-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: 4px;
            overflow: hidden;
            border-left: 3px solid transparent;
            transition: border-color 0.3s ease;
        }

        .stat-header {
            position: relative;
            height: 36px;
            padding: 0 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            overflow: hidden;
        }
        .stat-header:hover {
            background-color: var(--card-hover);
        }

        .bg-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: var(--accent-cyan);
            opacity: 0.1;
            z-index: 0;
            width: 0%;
            transition: width 0.5s ease, background-color 0.3s ease;
        }

        .header-content {
            position: relative;
            z-index: 1;
            display: flex;
            width: 100%;
            justify-content: space-between;
            align-items: center;
        }

        .stat-name {
            font-weight: bold;
            font-size: 0.95rem;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
        }

        .meta-group {
            display: flex;
            align-items: center;
            /* font-family: monospace; å‰Šé™¤ã—ã¦çµ±ä¸€ãƒ•ã‚©ãƒ³ãƒˆã¸ */
            white-space: nowrap;
        }

        .label-text { font-size: 0.75rem; color: #888; margin-right: 4px; }
        .val-text { font-size: 1rem; color: #fff; min-width: 60px; text-align: right; }
        .eff-text { font-size: 0.9rem; color: var(--accent-cyan); min-width: 60px; text-align: right; }
        
        .spacer { width: 20px; }
        .arrow { font-size: 0.8rem; color: #555; margin-left: 10px; transition: transform 0.3s; }
        
        .stat-card[data-rank="1"]:not([data-over="true"]) { border-left-color: var(--accent-yellow); }
        .stat-card[data-rank="1"]:not([data-over="true"]) .eff-text { color: var(--accent-yellow); }
        .stat-card[data-rank="1"]:not([data-over="true"]) .bg-bar { background-color: var(--accent-yellow); opacity: 0.15; }

        .stat-card:not([data-rank="1"]) { border-left-color: var(--accent-cyan); }

        /* Details Section */
        .details-section {
            background-color: #111;
            border-top: 1px solid #222;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
        }
        .details-section.open { max-height: 2000px; padding: 10px; overflow: visible; }
        .details-section.open + .header-content .arrow { transform: rotate(180deg); } 

        .breakdown-row {
            display: grid;
            gap: 8px;
            margin-bottom: 4px;
            align-items: center;
        }
        
        .breakdown-row.crit { grid-template-columns: 1fr 70px 15px 60px 30px; }
        .breakdown-row.simple { grid-template-columns: 1fr 70px 15px 30px; }

        .breakdown-row input[type="text"] {
            background: transparent; border: none; color: #aaa; border-bottom: 1px solid #333; 
            padding: 2px 5px; width: 100%; font-size: 0.9rem;
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        .breakdown-row input[type="number"] {
            background: var(--input-bg); border: 1px solid #333; border-radius: 4px; color: #fff; 
            padding: 4px; text-align: right; font-weight: bold; width: 100%; font-size: 0.9rem;
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        .breakdown-row select {
            background: #222; border: 1px solid #444; color: #fff; padding: 2px; border-radius: 4px; font-size: 0.8rem;
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        
        .unit-label { color: #555; font-size: 0.8rem; text-align: center; }

        .remove-btn { 
            color: #666; cursor: pointer; text-align: center; font-weight: bold; font-size: 1rem;
            line-height: 24px; height: 24px; border-radius: 4px;
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        .remove-btn:hover { background-color: var(--danger); color: #fff; }
        .remove-placeholder { height: 24px; width: 100%; }

        .add-btn {
            background: #222; border: 1px dashed #444; color: #666; width: 100%; 
            padding: 4px; border-radius: 4px; cursor: pointer; margin-top: 5px; font-size: 0.8rem;
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        .add-btn:hover { background: #333; color: #fff; }
        
        /* è¨ˆç®—å¼ï¼ˆæ–œä½“å‰Šé™¤ãƒ»ãƒ•ã‚©ãƒ³ãƒˆçµ±ä¸€ï¼‰ */
        .formula-note { 
            font-size: 0.9rem; 
            color: #666; 
            margin-bottom: 10px; 
            /* font-style: italic; å‰Šé™¤ */
            /* font-family: monospace; å‰Šé™¤ */
        }
        
        /* å›ºå®šå€¤ï¼ˆæ–œä½“å‰Šé™¤ãƒ»ãƒ•ã‚©ãƒ³ãƒˆçµ±ä¸€ï¼‰ */
        .fixed-val { 
            color: #555 !important; 
            /* font-style: italic; å‰Šé™¤ */
            pointer-events: none; 
            border: none !important; 
            background: transparent !important; 
        }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0; top: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.7); 
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #1a1a1a;
            margin: 5% auto; 
            padding: 0;
            border: 1px solid var(--accent-cyan);
            border-radius: 12px;
            width: 90%; 
            max-width: 700px;
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.3);
            color: #fff;
            animation: modalFadeIn 0.3s;
        }
        @keyframes modalFadeIn {
            from {opacity: 0; transform: translateY(-20px);}
            to {opacity: 1; transform: translateY(0);}
        }
        .modal-header {
            padding: 15px 20px;
            background: #111;
            border-bottom: 1px solid #333;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: var(--accent-cyan); }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
        .close-btn:hover { color: #fff; }
        
        .modal-body { padding: 20px; }
        
        .guide-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        @media (max-width: 600px) { .guide-grid { grid-template-columns: 1fr; } }

        .guide-step {
            background: #222;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #555;
        }
        .step-num { 
            font-size: 0.8rem; color: var(--accent-cyan); font-weight: bold; margin-bottom: 5px; display: block; 
        }
        .step-text { font-size: 0.95rem; line-height: 1.6; }
        .highlight-yellow { color: var(--accent-yellow); font-weight: bold; }
        .highlight-red { color: var(--alert-red); font-weight: bold; }

        .modal-footer {
            padding: 15px;
            text-align: center;
            border-top: 1px solid #333;
            font-size: 0.9rem;
            color: #888;
        }

    </style>
</head>
<body>

<div class="container">
    <div class="nav-area">
        <button id="helpBtn" class="help-btn">?</button>
    </div>

    <header>
        <h1>ELSWORDã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åŠ¹ç‡è¨ˆç®—</h1>
        <div>
            <span class="total-label-compact">TOTAL MULTIPLIER</span>
            <span class="total-display-compact" id="totalDisplay">0.00</span>
        </div>
    </header>

    <div class="stats-list" id="statsList"></div>
</div>

<div id="helpModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">ğŸ“Œ ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</div>
            <span class="close-btn" id="closeModal">&times;</span>
        </div>
        <div class="modal-body">
            <div class="guide-grid">
                <div class="guide-step" style="border-left-color: var(--accent-cyan);">
                    <span class="step-num">STEP 1</span>
                    <div class="step-text">
                        é …ç›®ã®ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚„ãƒ‘ãƒƒã‚·ãƒ–ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¾ã™ã€‚<br>
                        <small>â€»ã€Œæ–°è¦ã€ãƒœã‚¿ãƒ³ã§é …ç›®ã‚’è¿½åŠ ã§ãã¾ã™ã€‚</small>
                    </div>
                </div>
                <div class="guide-step" style="border-left-color: var(--accent-cyan);">
                    <span class="step-num">STEP 2</span>
                    <div class="step-text">
                        å³å´ã®æ•°å€¤<strong>ã€Œ1%ä¸Šæ˜‡åŠ¹ç‡ã€</strong>ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚<br>
                        ã“ã®æ•°å€¤ãŒå¤§ãã„ã»ã©ã€ãã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¸Šã’ã‚‹æ©æµãŒãƒ‡ã‚«ã„ã§ã™ï¼
                    </div>
                </div>
                <div class="guide-step" style="border-left-color: var(--accent-yellow);">
                    <span class="step-num">STEP 3</span>
                    <div class="step-text">
                        ä¸€ç•ªåŠ¹ç‡ãŒè‰¯ã„é …ç›®ã¯<span class="highlight-yellow">é»„è‰²ã®ãƒãƒ¼</span>ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
                        è¿·ã£ãŸã‚‰é»„è‰²ã®é …ç›®ã‚’å¼·åŒ–ã—ã¾ã—ã‚‡ã†ï¼
                    </div>
                </div>
                <div class="guide-step" style="border-left-color: var(--alert-red);">
                    <span class="step-num">ATTENTION</span>
                    <div class="step-text">
                        åˆè¨ˆãŒ280%ã‚’è¶…ãˆã‚‹ã¨<span class="highlight-red">èµ¤è‰²ã®ãƒãƒ¼</span>ã«ãªã‚Šã¾ã™ã€‚<br>
                        æ¸›è¡°ãƒ©ã‚¤ãƒ³ãªã®ã§ã€ã“ã‚Œä»¥ä¸Šç››ã‚‹ã®ã¯ã‚³ã‚¹ãƒ‘ãŒæ‚ªã„ã§ã™ï¼
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            è¨ˆç®—æ©Ÿã‚’ä½¿ã£ã¦æœ€å¼·ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç›®æŒ‡ãã†ï¼ğŸ”¥
        </div>
    </div>
</div>

<script>
    // ãƒ‡ãƒ¼ã‚¿åˆæœŸè¨­å®š
    let statsData = [
        { 
            id: "atk_percent", 
            name: "ç‰©é­”æ”»æ’ƒåŠ›(%)", 
            calcType: "simple",
            items: [
                { label: "åŸºç¤å€¤(å›ºå®š)", val: 100, fixed: true },
                { label: "æ­¦å™¨é­”åŠ›çŸ³åŠ¹æœ", val: 49.5 },
                { label: "ã‚¨ã‚¯ã‚µå†éŒ¬åŠ¹æœ", val: 8 },
                { label: "ãƒ¬ã‚¢ãƒã‚»ãƒƒãƒˆåŠ¹æœ", val: 6 },
                { label: "ãƒ¬ã‚¢ãƒã‚¢ã‚¯ã‚»åŠ¹æœ", val: 9 },
                { label: "ã‚¹ã‚­ãƒªãƒ³åŠ¹æœ", val: 0.5 },
                { label: "ãƒšãƒƒãƒˆåŠ¹æœ", val: 2 },
                { label: "ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆåŠ¹æœ", val: 3 },
                { label: "ã‚¨ãƒ«ã‚³ãƒ¬åŠ¹æœ", val: 3.75 },
                { label: "ã‚·ãƒŠã‚¸ãƒ¼", val: 1 }
            ] 
        },
        { 
            id: "cri_dmg", 
            name: "ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ€ãƒ¡ãƒ¼ã‚¸", 
            calcType: "crit",
            items: [
                { label: "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨è¨˜", val: 215.00, type: "stat_window", fixed: false },
                { label: "åŠ ç®—ãƒ‘ãƒƒã‚·ãƒ–", val: 0, type: "add", fixed: false },
                { label: "ä¹—ç®—ãƒ‘ãƒƒã‚·ãƒ–", val: 0, type: "multi", fixed: false },
                { label: "ã‚¢ãƒƒãƒˆãƒè‰æœ¨", val: 26, type: "multi", fixed: false },
                { label: "ã‚¨ã‚¯ã‚µèµ¤ã‚»ãƒƒãƒˆ", val: 10, type: "multi", fixed: false },
                { label: "åˆ»å°", val: 5, type: "multi", fixed: false },
                { label: "ãƒã‚¨ã‚¹ãƒˆãƒ­ãƒ˜ã‚¤ãƒ­ãƒ¼", val: 2, type: "multi", fixed: false },
            ]
        },
        { 
            id: "boss_dmg", 
            name: "ãƒœã‚¹ã«ä¸ãˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—åŠ ", 
            calcType: "simple",
            items: [
                { label: "åŸºç¤å€¤(å›ºå®š)", val: 100, fixed: true },
                { label: "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨è¨˜", val: 150.00 },
                { label: "åŠ ç®—ãƒ‘ãƒƒã‚·ãƒ–", val: 20.00 },
                { label: "ã‚®ãƒ«ãƒ‰ã‚¹ã‚­ãƒ«", val: 2.50 }
            ]
        },
        { 
            id: "all_skill", 
            name: "å…¨ã¦ã®ã‚¹ã‚­ãƒ«ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—åŠ ", 
            calcType: "simple",
            items: [
                { label: "åŸºç¤å€¤(å›ºå®š)", val: 100, fixed: true }, 
                { label: "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨è¨˜", val: 104.50 }
            ] 
        },
        { 
            id: "trans_skill", 
            name: "å¼·çƒˆã€è¶…è¶Šã‚¹ã‚­ãƒ«ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—åŠ ", 
            calcType: "simple",
            items: [
                { label: "åŸºç¤å€¤(å›ºå®š)", val: 100, fixed: true }, 
                { label: "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨è¨˜", val: 122.00 }
            ] 
        },
        { 
            id: "polar", 
            name: "ä¸¡æ¥µåŒ–ï¼šæ”»æ’ƒ/å—ã‘ã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—åŠ ", 
            calcType: "simple",
            items: [
                { label: "åŸºç¤å€¤(å›ºå®š)", val: 100, fixed: true }, 
                { label: "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨è¨˜", val: 53.70 }
            ] 
        },
        { 
            id: "dot", 
            name: "ä¸ãˆãŸãƒ€ãƒ¡ãƒ¼ã‚¸ã®n%ã‚’è¿½åŠ æŒç¶šãƒ€ãƒ¡ãƒ¼ã‚¸", 
            calcType: "simple",
            items: [
                { label: "åŸºç¤å€¤(å›ºå®š)", val: 100, fixed: true },
                { label: "ãƒªãƒ³ã‚¯ã‚¢ãƒåŠ¹æœ", val: 2.00 },
                { label: "ã‚¨ã‚¯ã‚µä¸Šè¡£å›è·¯", val: 12.00 },
                { label: "ã‚¨ã‚¯ã‚µãƒãƒƒãƒ—", val: 12.00 },
                { label: "ã‚¢ãƒƒãƒˆãƒä¸Šã‚¢ã‚¯ã‚»", val: 5.00 },
                { label: "ãƒ¬ã‚¢ãƒã‚»ãƒƒãƒˆåŠ¹æœ", val: 12.00 },
                { label: "ãƒ¬ã‚¢ãƒæ­¦å™¨åŠ¹æœ", val: 5.00 },
                { label: "ãƒ¬ã‚¢ãƒã‚¢ã‚¯ã‚»åŠ¹æœ", val: 7.00 },
                { label: "ã‚·ãƒŠã‚¸ãƒ¼ï¼šæ­ªæ›²", val: 2.00 }
            ]
        },
        { 
            id: "hp100_under", 
            name: "HP100ï¼…ä»¥ä¸‹ã®æ•µã‚’æ”»æ’ƒæ™‚ã€ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—åŠ ", 
            calcType: "simple",
            items: [
                { label: "åŸºç¤å€¤(å›ºå®š)", val: 100, fixed: true },
                { label: "æ­¦å™¨åŠ¹æœ", val: 5 },
                { label: "ãƒ¬ã‚¢ãƒã‚»ãƒƒãƒˆåŠ¹æœ", val: 10 }
            ] 
        },
        { 
            id: "hp50_over", 
            name: "HP50ï¼…è¶…éã®æ•µã‚’æ”»æ’ƒæ™‚ã€ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—åŠ ", 
            calcType: "simple",
            items: [
                { label: "åŸºç¤å€¤(å›ºå®š)", val: 100, fixed: true },
                { label: "ã‚¨ã‚¯ã‚µå›è·¯åŠ¹æœ", val: 10 },
                { label: "ã‚¨ã‚¯ã‚µãƒãƒƒãƒ—åŠ¹æœ", val: 5 }
            ] 
        },
        { 
            id: "hp50_under", 
            name: "HP50ï¼…ä»¥ä¸‹ã®æ•µã‚’æ”»æ’ƒæ™‚ã€ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—åŠ ", 
            calcType: "simple",
            items: [
                { label: "åŸºç¤å€¤(å›ºå®š)", val: 100, fixed: true },
                { label: "ã‚¨ã‚¯ã‚µå›è·¯åŠ¹æœ", val: 10 },
                { label: "ã‚¨ã‚¯ã‚µãƒãƒƒãƒ—åŠ¹æœ", val: 5 }
            ] 
        },
        { 
            id: "hp30", 
            name: "HP30ï¼…ä»¥ä¸‹ã®æ•µã‚’æ”»æ’ƒæ™‚ã€ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—åŠ ", 
            calcType: "simple",
            items: [
                { label: "åŸºç¤å€¤(å›ºå®š)", val: 100, fixed: true },
                { label: "ã‚½ã‚±ãƒƒãƒˆåŠ¹æœ", val: 0 }
            ] 
        },
    ];

    const listContainer = document.getElementById('statsList');
    const totalDisplay = document.getElementById('totalDisplay');
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®è¦ç´ 
    const modal = document.getElementById("helpModal");
    const helpBtn = document.getElementById("helpBtn");
    const closeBtn = document.getElementById("closeModal");

    function init() {
        render();
        calculate();
        setupModal();
    }
    
    function setupModal() {
        helpBtn.onclick = function() {
            modal.style.display = "block";
        }
        closeBtn.onclick = function() {
            modal.style.display = "none";
        }
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    }

    function render() {
        listContainer.innerHTML = '';
        statsData.forEach((cat, index) => {
            const card = document.createElement('div');
            card.className = 'stat-card';
            card.id = `card-${index}`;

            const header = document.createElement('div');
            header.className = 'stat-header';
            header.onclick = () => toggleDetails(index);
            header.innerHTML = `
                <div class="bg-bar" id="bar-${index}"></div>
                <div class="header-content">
                    <div class="stat-name">${cat.name}</div>
                    <div class="meta-group">
                        <span class="label-text">åˆè¨ˆ:</span>
                        <span class="val-text" id="total-${index}">0%</span>
                        
                        <div class="spacer"></div>
                        
                        <span class="label-text">1%ä¸Šæ˜‡åŠ¹ç‡:</span>
                        <span class="eff-text" id="eff-${index}">+0%</span>
                        
                        <span class="arrow" id="arrow-${index}">â–¼</span>
                    </div>
                </div>
            `;

            const details = document.createElement('div');
            details.className = 'details-section';
            details.id = `details-${index}`;

            // --- è¨ˆç®—å¼è¡¨ç¤º ---
            const note = document.createElement('div');
            note.className = 'formula-note';
            if(cat.calcType === 'crit') {
                note.innerText = 'å¼: (ã‚¹ãƒ†çª“ - 150) + åŠ ç®— + (150 Ã— ä¹—ç®—è£œæ­£)';
            } else {
                note.innerText = 'å¼: åŸºç¤å€¤(100%) + åŠ ç®—å€¤ã®åˆè¨ˆ';
            }
            details.appendChild(note);
            // ----------------

            const rowsContainer = document.createElement('div');
            rowsContainer.id = `rows-${index}`;
            details.appendChild(rowsContainer);

            const addBtn = document.createElement('button');
            addBtn.className = 'add-btn';
            addBtn.innerText = 'ï¼‹ é …ç›®ã‚’è¿½åŠ ';
            addBtn.onclick = (e) => { e.stopPropagation(); addItem(index); };
            details.appendChild(addBtn);

            card.appendChild(header);
            card.appendChild(details);
            listContainer.appendChild(card);

            renderRows(index);
        });
    }

    function renderRows(catIndex) {
        const container = document.getElementById(`rows-${catIndex}`);
        const cat = statsData[catIndex];
        container.innerHTML = '';
        
        cat.items.forEach((item, itemIndex) => {
            const row = document.createElement('div');
            row.className = cat.calcType === 'crit' ? 'breakdown-row crit' : 'breakdown-row simple';

            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.value = item.label;
            nameInput.placeholder = 'é …ç›®å';
            if(item.fixed) nameInput.readOnly = true;
            nameInput.oninput = (e) => { cat.items[itemIndex].label = e.target.value; };

            const valInput = document.createElement('input');
            valInput.type = 'number';
            valInput.value = item.val;
            valInput.step = '0.1';
            
            if(item.fixed) {
                valInput.className = 'fixed-val';
                valInput.readOnly = true;
            }

            valInput.oninput = (e) => {
                let v = parseFloat(e.target.value);
                if(isNaN(v)) v = 0;
                cat.items[itemIndex].val = v;
                calculate();
            };
            
            const unitLabel = document.createElement('div');
            unitLabel.className = 'unit-label';
            unitLabel.innerText = '%';

            row.appendChild(nameInput);
            row.appendChild(valInput);
            row.appendChild(unitLabel);

            if (cat.calcType === 'crit') {
                if (item.type === 'stat_window') {
                   const emptyBox = document.createElement('div');
                   row.appendChild(emptyBox);
                } else {
                    const typeSelect = document.createElement('select');
                    const ops = [
                        {val: 'add', text: 'åŠ ç®—'},
                        {val: 'multi', text: 'ä¹—ç®—'},
                    ];
                    
                    ops.forEach(o => {
                        const op = document.createElement('option');
                        op.value = o.val;
                        op.text = o.text;
                        if(item.type === o.val) op.selected = true;
                        typeSelect.appendChild(op);
                    });
                    typeSelect.onchange = (e) => {
                        cat.items[itemIndex].type = e.target.value;
                        calculate();
                    };
                    row.appendChild(typeSelect);
                }
            }

            if(!item.fixed) {
                const delBtn = document.createElement('div');
                delBtn.className = 'remove-btn';
                delBtn.innerText = 'Ã—';
                delBtn.onclick = () => {
                    cat.items.splice(itemIndex, 1);
                    renderRows(catIndex);
                    calculate();
                };
                row.appendChild(delBtn);
            } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'remove-placeholder';
                row.appendChild(placeholder);
            }

            container.appendChild(row);
        });
    }

    function addItem(catIndex) {
        const cat = statsData[catIndex];
        const type = cat.calcType === 'crit' ? 'multi' : 'add';
        cat.items.push({ label: 'æ–°è¦', val: 0, fixed: false, type: type });
        renderRows(catIndex);
    }

    function toggleDetails(index) {
        document.getElementById(`details-${index}`).classList.toggle('open');
        const arrow = document.getElementById(`arrow-${index}`);
        if(document.getElementById(`details-${index}`).classList.contains('open')) {
            arrow.style.transform = 'rotate(180deg)';
        } else {
            arrow.style.transform = 'rotate(0deg)';
        }
    }

    function calculate() {
        let globalMultiplier = 1.0;
        let efficiencies = [];

        statsData.forEach((cat, idx) => {
            let catTotal = 0;

            if (cat.calcType === 'crit') {
                let additiveTotal = 0;
                let multiplierProduct = 1.0;
                cat.items.forEach(item => {
                    if (item.type === 'stat_window') {
                        additiveTotal += (item.val - 150);
                    } else if (item.type === 'add') {
                        additiveTotal += item.val;
                    } else if (item.type === 'multi') {
                        multiplierProduct *= (1 + item.val / 100);
                    }
                });
                const base = 150;
                catTotal = additiveTotal + (base * multiplierProduct);
            } else {
                catTotal = cat.items.reduce((sum, item) => sum + item.val, 0);
            }

            if (catTotal <= 0) catTotal = 1;
            
            document.getElementById(`total-${idx}`).innerText = catTotal.toFixed(2) + '%';
            
            globalMultiplier *= (catTotal / 100);

            const eff = (1 / catTotal) * 100;
            efficiencies.push({ index: idx, val: eff, total: catTotal });
            document.getElementById(`eff-${idx}`).innerText = '+' + eff.toFixed(3) + '%';
        });

        const maxEff = Math.max(...efficiencies.map(e => e.val));
        const sorted = [...efficiencies].sort((a, b) => b.val - a.val);

        efficiencies.forEach(item => {
            const rank = sorted.findIndex(e => e.index === item.index) + 1;
            const card = document.getElementById(`card-${item.index}`);
            const bar = document.getElementById(`bar-${item.index}`);
            
            card.setAttribute('data-rank', rank);
            bar.style.backgroundColor = '';
            card.style.borderLeftColor = '';
            
            const width = (item.val / maxEff) * 100;
            bar.style.width = `${width}%`;

            if (item.total > 280) {
                card.setAttribute('data-over', 'true');
                bar.style.backgroundColor = 'var(--alert-red)';
                bar.style.opacity = 0.2;
                card.style.borderLeftColor = 'var(--alert-red)';
            } else {
                card.setAttribute('data-over', 'false');
                if (rank > 1) {
                    const opacity = Math.max(0.1, (item.val / maxEff) * 0.2); 
                    bar.style.opacity = opacity;
                    card.style.borderLeftColor = `rgba(0, 229, 255, ${Math.max(0.3, item.val / maxEff)})`;
                } else {
                    bar.style.opacity = 0.15;
                }
            }
        });

        totalDisplay.innerText = globalMultiplier.toLocaleString(undefined, { maximumFractionDigits: 2, minimumFractionDigits: 2 });
    }

    init();

</script>

</body>
</html>